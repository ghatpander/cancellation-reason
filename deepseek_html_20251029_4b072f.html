<!DOCTYPE html>
<html>
<head>
    <title>Cancel Visit - KidsAbility</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 600px; 
            margin: 40px auto; 
            padding: 20px;
            background-color: #f8f9fa;
        }
        .header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #274683;
        }
        .logo {
            height: 60px;
            margin-right: 15px;
        }
        .header-text {
            color: #274683;
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-top: 4px solid #274683;
        }
        h2 {
            color: #274683;
            margin-top: 0;
        }
        select, button, textarea { 
            width: 100%; 
            padding: 12px; 
            margin: 10px 0; 
            font-size: 16px;
            border-radius: 4px;
            border: 1px solid #ddd;
            box-sizing: border-box;
        }
        textarea {
            height: 80px;
            resize: vertical;
            font-family: Arial, sans-serif;
        }
        button { 
            background: #274683; 
            color: white; 
            border: none; 
            cursor: pointer; 
            font-weight: bold;
            transition: background 0.3s;
        }
        button:hover { 
            background: #1d3567; 
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            padding: 15px; 
            border-radius: 4px;
            margin-top: 15px;
        }
        .required {
            color: #dc3545;
        }
        .other-reason-container {
            display: none;
            margin-top: 10px;
            animation: fadeIn 0.3s ease-in;
        }
        .char-counter {
            font-size: 12px;
            color: #666;
            text-align: right;
            margin-top: -5px;
            margin-bottom: 10px;
        }
        .char-counter.warning {
            color: #dc3545;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://media.licdn.com/dms/image/v2/C560BAQHm1ieVcnGemg/company-logo_200_200/company-logo_200_200/0/1657570801204/kidsability_logo?e=2147483647&v=beta&t=-uzhCYQ2o56jPpWrAb8WGCfK3vlWQ84hRE_PsdV-TDY" 
             alt="KidsAbility Logo" class="logo">
        <div class="header-text">
            <h1 style="margin: 0; font-size: 24px;">KidsAbility</h1>
            <p style="margin: 0; font-size: 14px;">Centre for Child Development</p>
        </div>
    </div>

    <div class="container">
        <h2>Cancel Visit</h2>
        <p>We're sorry you won't be able to make it. Please let us know why you need to cancel:</p>
        
        <label for="cancellationReason">Cancellation Reason <span class="required">*</span></label>
        <select id="cancellationReason" onchange="toggleOtherReason()">
            <option value="">Select a reason...</option>
            <option value="sick_illness">Sick/Illness</option>
            <option value="transportation">Transportation Issues</option>
            <option value="family_emergency">Family Emergency</option>
            <option value="schedule_conflict">Schedule Conflict</option>
            <option value="other">Other Reason</option>
        </select>
        
        <div id="otherReasonContainer" class="other-reason-container">
            <label for="otherReasonText">Please specify the reason:</label>
            <textarea id="otherReasonText" 
                      placeholder="Please provide details about your cancellation reason (max 100 characters)..."
                      maxlength="100"
                      oninput="updateCharCounter()"></textarea>
            <div id="charCounter" class="char-counter">0/100 characters</div>
        </div>
        
        <button onclick="submitCancellation()">Submit Cancellation</button>
        
        <div id="successMessage" class="success" style="display: none;">
            <strong>Thank you!</strong> Your cancellation reason has been recorded. You may close this window.
        </div>
    </div>

    <script>
        function toggleOtherReason() {
            const cancellationReason = document.getElementById('cancellationReason').value;
            const otherReasonContainer = document.getElementById('otherReasonContainer');
            const otherReasonText = document.getElementById('otherReasonText');
            
            if (cancellationReason === 'other') {
                otherReasonContainer.style.display = 'block';
                otherReasonText.required = true;
                updateCharCounter(); // Initialize character counter
            } else {
                otherReasonContainer.style.display = 'none';
                otherReasonText.required = false;
                otherReasonText.value = ''; // Clear the text when switching away from "Other"
            }
        }

        function updateCharCounter() {
            const textarea = document.getElementById('otherReasonText');
            const charCounter = document.getElementById('charCounter');
            const currentLength = textarea.value.length;
            const maxLength = 100;
            
            charCounter.textContent = `${currentLength}/${maxLength} characters`;
            
            // Add warning class when approaching or exceeding limit
            if (currentLength >= 90) {
                charCounter.classList.add('warning');
            } else {
                charCounter.classList.remove('warning');
            }
        }

        function submitCancellation() {
            const reasonSelect = document.getElementById('cancellationReason');
            const reason = reasonSelect.value;
            const otherReasonText = document.getElementById('otherReasonText').value;
            
            if (!reason) {
                alert('Please select a cancellation reason');
                return;
            }

            // If "Other" is selected but no text provided
            if (reason === 'other' && !otherReasonText.trim()) {
                alert('Please provide details for "Other Reason"');
                document.getElementById('otherReasonText').focus();
                return;
            }

            // If "Other" is selected and text exceeds 100 characters
            if (reason === 'other' && otherReasonText.length > 100) {
                alert('Please limit your reason to 100 characters or less');
                document.getElementById('otherReasonText').focus();
                return;
            }

            // Determine the final cancellation reason value
            let finalCancellationReason;
            if (reason === 'other') {
                finalCancellationReason = otherReasonText.trim();
            } else {
                finalCancellationReason = reason;
            }

            // Get all URL parameters from the current page
            const urlParams = new URLSearchParams(window.location.search);
            
            // Add the cancellation reason to existing parameters
            urlParams.set('cancellationReason', finalCancellationReason);
            
            // Build the final webhook URL with ALL original parameters + cancellation reason
            const baseUrl = 'https://hook.connector.alayacare.ca/0b5gpd9qn90kvf31rn1h724ubm9ae78p';
            const finalUrl = `${baseUrl}?${urlParams.toString()}`;
            
            // Show success message
            document.getElementById('successMessage').style.display = 'block';
            
            // Disable the button to prevent multiple submissions
            const submitButton = document.querySelector('button');
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';
            submitButton.style.background = '#6c757d';
            
            // Call the webhook in background
            fetch(finalUrl)
                .then(() => {
                    console.log('Cancellation recorded successfully');
                    submitButton.textContent = 'Submitted Successfully';
                })
                .catch(err => {
                    console.error('Error:', err);
                    document.getElementById('successMessage').innerHTML = 
                        '<strong>Note:</strong> There was an issue submitting your reason, but we have recorded your cancellation.';
                    document.getElementById('successMessage').style.display = 'block';
                    document.getElementById('successMessage').style.background = '#fff3cd';
                    document.getElementById('successMessage').style.color = '#856404';
                });
        }

        // Auto-submit if reason is provided in URL (for testing)
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const autoReason = urlParams.get('autoReason');
            if (autoReason) {
                document.getElementById('cancellationReason').value = autoReason;
                toggleOtherReason(); // Make sure to show/hide other reason field
                submitCancellation();
            }
        });
    </script>
</body>
</html>